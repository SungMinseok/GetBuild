# PyInstaller 빌드 오류 수정 내역

## 🐛 발생한 오류

### 증상 1: Windows 버전 범위 초과
```
struct.error: argument out of range
```

PyInstaller 실행 중 Windows 버전 정보를 작성할 때 발생하는 오류입니다.

### 원인
Windows 버전 정보의 각 부분은 **0-65535 범위**여야 하는데, 기존 코드에서 `yymmdd` 형식(예: 251027)을 사용하여 65535를 초과했습니다.

```python
# 문제가 있던 코드
yymmdd = f"{yy}{mm}{dd}"  # 251027 → 65535 초과!
file_version_parts = [major, minor, yymmdd, hhmm]
```

### 증상 2: 불필요한 build 폴더 생성
PyInstaller가 빌드 중간 산물을 `build/` 폴더에 생성하여 공간을 차지하고 정리가 번거로웠습니다.

## ✅ 수정 내용

### 1. Windows 버전 형식 변경 (build_release.py)

**문제 해결**: `yymmdd` → `mmdd` 형식으로 변경

#### 변경 전
```python
# Windows 버전 형식: 3,0,yymmdd,hhmm
yymmdd = f"{yy}{mm}{dd}"  # 6자리 (예: 251027)
file_version_parts = [major, minor, yymmdd, hhmm]
```

#### 변경 후
```python
# Windows 버전 형식: 3,0,mmdd,hhmm (각 부분은 0-65535 범위)
mmdd = f"{mm}{dd}"  # 4자리 (예: 1027)
file_version_parts = [major, minor, mmdd, hhmm]
```

**예시**:
- 표시용 버전: `3.0-25.10.27.1430`
- Windows 파일 버전: `3,0,1027,1430`
  - Major: `3`
  - Minor: `0`
  - Build: `1027` (mmdd) ✅ 65535 이하
  - Revision: `1430` (hhmm)

### 2. build 폴더 자동 정리

**문제 해결**: onefile 모드 사용 + 빌드 후 자동 정리

#### PyInstaller 실행 옵션 명시
```python
# build_release.py - run_pyinstaller()
result = subprocess.run(
    [
        'pyinstaller',
        '--clean',           # 캐시 정리
        '--noconfirm',       # 자동 확인
        '--distpath', 'dist',  # 출력 디렉토리
        '--workpath', 'build', # 작업 디렉토리
        'QuickBuild_release.spec'
    ],
    check=True,
    capture_output=True,
    text=True
)
```

#### 빌드 후 자동 정리
```python
# build_release.py - cleanup()
dirs_to_remove = [
    'build'  # PyInstaller 작업 디렉토리 (임시 파일)
]

for dir_name in dirs_to_remove:
    try:
        if Path(dir_name).exists():
            shutil.rmtree(dir_name)
            print(f"  ✓ {dir_name}/ 폴더 삭제")
    except Exception as e:
        print(f"  ⚠ {dir_name}/ 삭제 실패: {e}")
```

**결과**:
- ✅ 빌드 완료 후 `build/` 폴더 자동 삭제
- ✅ `dist/` 폴더에만 최종 결과물 유지
- ✅ 디스크 공간 절약

### 3. version.txt 제거, version.json만 사용

#### update_version.py 수정
```python
# 변경 전: version.txt와 version.json 모두 생성
with open('version.json', 'w', encoding='utf-8') as f:
    json.dump(data, f, ensure_ascii=False, indent=2)
with open('version.txt', 'w', encoding='utf-8') as f:
    f.write(new_version)

# 변경 후: version.json만 생성
with open('version.json', 'w', encoding='utf-8') as f:
    json.dump(data, f, ensure_ascii=False, indent=2)
```

#### index_v2.py 수정
```python
def read_version(self) -> str:
    """버전 읽기 (version.json에서)"""
    try:
        import json
        with open("version.json", "r", encoding="utf-8") as f:
            version_data = json.load(f)
        return version_data.get('version', '3.0-25.10.26.1805')
    except FileNotFoundError:
        # version.json이 없으면 version.txt 시도 (하위 호환성)
        try:
            with open("version.txt", "r", encoding="utf-8") as f:
                return f.read().strip()
        except:
            return "3.0-25.10.26.1805"
    except:
        return "3.0-25.10.26.1805"
```

#### index.py 수정
동일한 방식으로 `read_version_from_file()` 메서드 수정

### 3. .gitignore 업데이트
```
# 임시 파일
version_info.txt
version.txt  ← 추가
QuickBuild_release.spec
```

## 📦 ZIP 패키지 내용

변경 후 ZIP 파일에는 `version.json`만 포함됩니다:

```
QuickBuild_3.0-25.10.27.1430.zip
├── QuickBuild.exe
├── version.json  ← JSON 형식, 더 많은 정보 포함
└── Readme.md (선택)
```

`version.json` 구조:
```json
{
  "version": "3.0-25.10.27.1430",
  "build_date": "2025-10-27",
  "update_url": "https://api.github.com/repos/SungMinseok/GetBuild/releases/latest",
  "changelog": [
    {
      "version": "3.0-25.10.27.1430",
      "date": "2025-10-27",
      "changes": ["변경사항 1", "변경사항 2"]
    }
  ]
}
```

## 🎯 장점

### version.json 사용의 이점
1. ✅ **더 많은 정보**: 버전, 날짜, changelog, 업데이트 URL 모두 포함
2. ✅ **구조화된 데이터**: JSON 형식으로 파싱 용이
3. ✅ **자동 업데이트 지원**: 앱 내 업데이트 체크 기능에 활용
4. ✅ **changelog 관리**: 버전별 변경사항 추적

### Windows 버전 형식 개선
1. ✅ **오류 해결**: 65535 범위 초과 문제 해결
2. ✅ **빌드 성공**: PyInstaller 정상 실행
3. ✅ **정보 유지**: 월/일 정보는 여전히 포함 (연도 제외)

## 🔍 테스트 방법

### 1. 버전 업데이트 테스트
```bash
python update_version.py "빌드 오류 수정"
```

**확인사항**:
- ✅ `version.json` 생성됨
- ✅ `version.txt` 생성되지 않음
- ✅ 버전 형식: `3.0-25.10.27.1430`

### 2. 빌드 테스트
```bash
python build_release.py
```

**확인사항**:
- ✅ Windows 파일 버전 출력: `3,0,1027,1430`
- ✅ PyInstaller 오류 없이 완료
- ✅ `dist/QuickBuild_<버전>.zip` 생성됨

### 3. ZIP 내용 확인
```bash
# ZIP 압축 해제 후
dir dist\extracted\
```

**확인사항**:
- ✅ `QuickBuild.exe` 존재
- ✅ `version.json` 존재
- ❌ `version.txt` 없음 (정상)

### 4. 앱 실행 테스트
```bash
# EXE 실행 후
# 메뉴 → About 확인
```

**확인사항**:
- ✅ 버전 번호 올바르게 표시
- ✅ 기능 정상 작동

## 📋 수정된 파일 목록

1. **build_release.py**
   - Windows 버전 형식 변경 (yymmdd → mmdd)
   - 디버그 출력 추가

2. **update_version.py**
   - version.txt 생성 제거
   - version.json만 생성

3. **index_v2.py**
   - `read_version()` 메서드 수정
   - version.json 우선 읽기

4. **index.py**
   - `read_version_from_file()` 메서드 수정
   - version.json 우선 읽기

5. **.gitignore**
   - version.txt 추가

## 🔄 하위 호환성

두 파일 모두 하위 호환성을 유지합니다:

```python
try:
    # version.json 시도
    with open("version.json", "r", encoding="utf-8") as f:
        version_data = json.load(f)
    return version_data.get('version', '3.0-25.10.26.1805')
except FileNotFoundError:
    # 없으면 version.txt 시도
    try:
        with open("version.txt", "r", encoding="utf-8") as f:
            return f.read().strip()
    except:
        return "3.0-25.10.26.1805"
```

이렇게 하면:
- ✅ 새 버전: version.json 사용
- ✅ 구 버전: version.txt 사용 가능
- ✅ 둘 다 없으면: 기본 버전 반환

## ⚠️ 주의사항

### 기존 version.txt 파일 처리

로컬에 `version.txt` 파일이 남아있을 수 있습니다:

```bash
# 삭제해도 무방 (자동 재생성 안 됨)
del version.txt

# 또는 Git에서만 제거
git rm --cached version.txt
git commit -m "Remove version.txt from Git tracking"
git push
```

### Windows 버전 제한사항

- 각 부분은 0-65535 범위여야 함
- `mmdd` 형식으로 연도 정보는 버전 문자열에만 포함
- 파일 속성에서 보이는 버전은 간소화됨

## ✅ 최종 결과

### 빌드 전
```
❌ struct.error: argument out of range
❌ 빌드 실패
❌ build/ 폴더 수동 정리 필요
```

### 빌드 후
```
✅ Windows 파일 버전: 3,0,1027,1635
✅ PyInstaller 빌드 완료 (onefile 모드)
✅ dist/QuickBuild_3.0-25.10.27.1635.zip 생성
✅ build/ 폴더 자동 정리 완료
```

### 최종 파일 구조
```
프로젝트/
├── dist/
│   └── QuickBuild_3.0-25.10.27.1635.zip  ← 최종 배포 파일
├── version.json                           ← 버전 정보
└── (build/ 폴더 없음 - 자동 정리됨)
```

### 개선 사항 요약

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| Windows 버전 | `3,0,251027,1635` ❌ | `3,0,1027,1635` ✅ |
| build 폴더 | 수동 정리 필요 | 자동 정리 |
| 버전 파일 | version.txt + version.json | version.json만 |
| 빌드 모드 | onefile (기존) | onefile (명시적) |
| 출력 경로 | 암묵적 | 명시적 (`--distpath`, `--workpath`) |

---

**수정일**: 2025-10-27  
**버전**: 2.0  
**상태**: ✅ 완료 및 테스트 완료

