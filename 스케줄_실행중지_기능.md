# 스케줄 실행/중지 버튼 기능

## ✨ 새로운 기능

스케줄이 실행 중일 때 **실행 버튼**이 **중지 버튼**으로 자동 변경됩니다.

## 🎯 동작 방식

### 1. 실행 전 (대기 상태)
```
┌─────────────────────────────┐
│ 스케줄 정보...              │
│                             │
│ [▶ 실행] (녹색)             │
└─────────────────────────────┘
```

### 2. 실행 중
```
┌─────────────────────────────┐
│ 스케줄 정보...              │
│ 🔄 클라복사 실행 중...      │
│ [⏹ 중지] (빨간색)           │
└─────────────────────────────┘
```

### 3. 실행 완료
```
┌─────────────────────────────┐
│ 스케줄 정보...              │
│ ✅ 완료: 15234 files copied │
│ [▶ 실행] (녹색)             │
└─────────────────────────────┘
```

## 🔧 기능 상세

### 버튼 변경

| 상태 | 버튼 텍스트 | 색상 | 동작 |
|------|------------|------|------|
| 대기 중 | ▶ 실행 | 녹색 (#4CAF50) | 스케줄 실행 |
| 실행 중 | ⏹ 중지 | 빨간색 (#FF5722) | 스케줄 중지 |

### 시각적 표시

#### 실행 중 UI
- 🔄 상태 메시지 표시 (주황색)
- 무한 진행 바 애니메이션
- 위젯 배경색 변경 (연한 주황색)
- 왼쪽 경계선 강조 (주황색 3px)

#### 완료 시 UI
- ✅ 완료 메시지 표시 (녹색)
- 진행 바 숨김
- 위젯 배경색 복원
- 3초 후 메시지 자동 숨김

### 중지 기능

#### 1. 중지 버튼 클릭
사용자가 실행 중인 스케줄의 "⏹ 중지" 버튼 클릭

#### 2. 확인 다이얼로그
```
┌────────────────────────────────┐
│ 스케줄 중지                    │
├────────────────────────────────┤
│ 'game 빌드 복사' 스케줄을     │
│ 중지하시겠습니까?              │
│                                │
│ 진행 중인 작업이 중단됩니다.   │
├────────────────────────────────┤
│        [예]        [아니오]    │
└────────────────────────────────┘
```

#### 3. 중지 처리
- 워커 스레드 강제 종료 (`terminate()`)
- 1초 대기 후 정리
- UI 상태 업데이트
- 로그 기록: `❌ 중지됨: [스케줄명]`

## 📝 코드 구조

### 1. UI 컴포넌트 (`ui/schedule_item_widget.py`)

#### 시그널 추가
```python
stop_requested = pyqtSignal(str)  # 중지 요청 (schedule_id)
```

#### 버튼 클릭 핸들러
```python
def on_run_clicked(self):
    """실행/중지 버튼 클릭"""
    if self.is_running:
        # 실행 중이면 중지 요청
        self.stop_requested.emit(self.schedule_id)
    else:
        # 실행 중이 아니면 실행 요청
        self.run_requested.emit(self.schedule_id)
```

#### 상태 변경
```python
def set_running_status(self, is_running: bool, status_message: str = ''):
    if is_running:
        # 버튼을 "중지"로 변경
        self.run_button.setText("⏹ 중지")
        self.run_button.setStyleSheet("""
            QPushButton {
                background-color: #FF5722;
                ...
            }
        """)
    else:
        # 버튼을 "실행"으로 복원
        self.run_button.setText("▶ 실행")
        self.run_button.setStyleSheet("""
            QPushButton {
                background-color: #4CAF50;
                ...
            }
        """)
```

### 2. 메인 로직 (`index_v2.py`)

#### 시그널 연결
```python
item_widget.stop_requested.connect(self.stop_schedule)
```

#### 중지 메서드
```python
def stop_schedule(self, schedule_id: str):
    """스케줄 중지"""
    # 1. 실행 중인지 확인
    if schedule_id not in self.running_workers:
        return
    
    # 2. 확인 다이얼로그
    reply = QMessageBox.question(...)
    
    if reply == QMessageBox.Yes:
        # 3. 워커 스레드 중지
        worker.terminate()
        worker.wait(1000)
        
        # 4. 정리
        del self.running_workers[schedule_id]
        
        # 5. UI 업데이트
        self.schedule_widgets[schedule_id].set_running_status(False, "중지됨")
```

## 🎬 사용 시나리오

### 시나리오 1: 수동 실행 후 중지
1. 사용자가 "▶ 실행" 버튼 클릭
2. 버튼이 "⏹ 중지"로 변경, 배경색 주황색
3. 파일 복사 진행 중...
4. 사용자가 "⏹ 중지" 버튼 클릭
5. 확인 다이얼로그 표시
6. "예" 클릭 → 작업 중단
7. 버튼이 "▶ 실행"으로 복원
8. 로그: "❌ 중지됨: game 빌드 복사"

### 시나리오 2: 자동 실행 중 중지
1. 스케줄 시간 도래 (예: 17:27)
2. 자동 실행 시작
3. 버튼이 "⏹ 중지"로 변경
4. 사용자가 중지 필요 시 "⏹ 중지" 클릭 가능
5. 나머지는 시나리오 1과 동일

### 시나리오 3: 정상 완료
1. 스케줄 실행 시작
2. 버튼이 "⏹ 중지"로 변경
3. 작업 정상 완료
4. 완료 메시지 표시: "✅ 완료: 15234 files copied"
5. 버튼이 "▶ 실행"으로 복원
6. 3초 후 완료 메시지 자동 숨김

## ⚠️ 주의사항

### 1. 강제 종료
- `worker.terminate()`는 스레드를 강제로 종료합니다
- 진행 중인 파일 복사가 중단될 수 있습니다
- 데이터 손실 가능성 있음 (파일 일부만 복사됨)

### 2. 리소스 정리
- 중지 시 1초 대기하여 정상적인 정리 시도
- 파일 핸들이 즉시 해제되지 않을 수 있음

### 3. UI 동기화
- 워커 스레드가 종료되면 자동으로 UI 업데이트
- `running_workers` 딕셔너리에서 제거
- 상태 요약 패널도 자동 업데이트

## 🔍 디버깅

### 로그 확인
```
[13:02:22] [수동 실행] game 빌드 복사
[13:02:22] [스케줄 시작] 클라복사 - 17:27 (클라복사)
...작업 진행중...
[13:03:15] [중지 요청] game 빌드 복사
[13:03:15] ❌ 중지됨: game 빌드 복사
```

### 실행 중인 워커 확인
```python
print(f"실행 중인 워커: {len(self.running_workers)}")
print(f"워커 ID: {list(self.running_workers.keys())}")
```

## 🚀 향후 개선 가능 사항

### 1. 우아한 중지 (Graceful Shutdown)
```python
# terminate() 대신 플래그 사용
worker.should_stop = True
# 워커에서 주기적으로 플래그 확인
if self.should_stop:
    break
```

### 2. 중지 이유 기록
```python
stop_reason = "사용자 요청"
self.log(f"❌ 중지됨: {schedule_name} (이유: {stop_reason})")
```

### 3. 중지 후 재개 기능
```python
# 중지된 지점부터 다시 시작
resume_from = last_copied_file
```

## ✅ 테스트 체크리스트

- [ ] 실행 버튼 클릭 → 버튼이 "중지"로 변경
- [ ] 중지 버튼 클릭 → 확인 다이얼로그 표시
- [ ] 중지 확인 → 작업 중단 및 로그 기록
- [ ] 중지 취소 → 작업 계속 진행
- [ ] 작업 완료 → 버튼이 "실행"으로 복원
- [ ] 여러 스케줄 동시 실행 → 각각 독립적으로 중지 가능
- [ ] 자동 실행 스케줄도 중지 가능
- [ ] 상태 요약 패널 업데이트 확인

---

**작성일**: 2025-10-27  
**버전**: 1.0  
**상태**: ✅ 구현 완료

